stages:
  - test
  - docker

test:
  stage: test
  image: node:20
  cache:
    key: npm-cache
    paths:
      - node_modules/
      - backend/node_modules/
      - frontend/node_modules/
  before_script:
    - node -v
    - npm ci
    - npm ci --prefix backend
    - npm ci --prefix frontend
  script:
    - npm test
    - npx swagger-cli validate backend/openapi.yaml

docker-build:
  stage: docker
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  rules:
    - if: '$CI_RUNNER_OS == "windows"'
      when: never
    - if: $CI_COMMIT_BRANCH
  variables:
    DOCKER_CONFIG: /kaniko/.docker
  before_script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
  script:
    - /kaniko/executor --context "$CI_PROJECT_DIR" --dockerfile backend.Dockerfile --destination "$CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA" --destination "$CI_REGISTRY_IMAGE/backend:latest"
    - /kaniko/executor --context "$CI_PROJECT_DIR" --dockerfile frontend.Dockerfile --build-arg VITE_API_BASE=${FRONTEND_API_BASE:-http://backend:5000/api} --destination "$CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA" --destination "$CI_REGISTRY_IMAGE/frontend:latest"
