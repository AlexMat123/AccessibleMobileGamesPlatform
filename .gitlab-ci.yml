stages:
  - test
  - docker

# Avoid relying on job-level images when running on the Windows shell executor;
# keep everything in PowerShell with the installed tooling.
default:
  before_script:
    - $ErrorActionPreference = 'Stop'

variables:
  REGISTRY_HOST: registry.git.cardiff.ac.uk
  IMAGE_PREFIX: $REGISTRY_HOST/$CI_PROJECT_PATH

test:
  stage: test
  cache:
    key: npm-cache
    paths:
      - node_modules/
      - backend/node_modules/
      - frontend/node_modules/
  before_script:
    - $ErrorActionPreference = 'Stop'
    - node -v
    - npm ci
    - npm ci --prefix backend
    - npm ci --prefix frontend
  script:
    - npm test
    - npx swagger-cli validate backend/openapi.yaml

docker-build:
  stage: docker
  rules:
    - if: $CI_COMMIT_BRANCH
  before_script:
    - $ErrorActionPreference = 'Stop'
    - docker version
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$REGISTRY_HOST"
  script:
    - docker build -f backend.Dockerfile -t "$IMAGE_PREFIX/backend:$CI_COMMIT_SHA" -t "$IMAGE_PREFIX/backend:latest" .
    - docker build -f frontend.Dockerfile --build-arg VITE_API_BASE=${FRONTEND_API_BASE:-http://backend:5000/api} -t "$IMAGE_PREFIX/frontend:$CI_COMMIT_SHA" -t "$IMAGE_PREFIX/frontend:latest" .
    - docker push "$IMAGE_PREFIX/backend:$CI_COMMIT_SHA"
    - docker push "$IMAGE_PREFIX/backend:latest"
    - docker push "$IMAGE_PREFIX/frontend:$CI_COMMIT_SHA"
    - docker push "$IMAGE_PREFIX/frontend:latest"
