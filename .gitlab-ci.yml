stages:
  - test
  - docker

test:
  stage: test
  image: node:20
  cache:
    key: npm-cache
    paths:
      - node_modules/
      - backend/node_modules/
      - frontend/node_modules/
  before_script:
    - node -v
    - npm ci
    - npm ci --prefix backend
    - npm ci --prefix frontend
  script:
    - npm test
    - npx swagger-cli validate backend/openapi.yaml

docker-build:
  stage: docker
  image: docker:24.0.7
  services:
    - name: docker:24.0.7-dind
      command: ["--tls=false"]
      privileged: true
      alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
  rules:
    - if: $CI_COMMIT_BRANCH
  before_script:
    - docker version
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    - docker build -f backend.Dockerfile -t "$CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA" -t "$CI_REGISTRY_IMAGE/backend:latest" .
    - docker build -f frontend.Dockerfile --build-arg VITE_API_BASE=${FRONTEND_API_BASE:-http://backend:5000/api} -t "$CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA" -t "$CI_REGISTRY_IMAGE/frontend:latest" .
    - docker push "$CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA"
    - docker push "$CI_REGISTRY_IMAGE/backend:latest"
    - docker push "$CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA"
    - docker push "$CI_REGISTRY_IMAGE/frontend:latest"
